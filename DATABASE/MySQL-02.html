<!DOCTYPE html>
<html>
 <head><link rel="stylesheet" type="text/css" href="style.css"></head>
 
<body>
<h1 id="my.cnfの設定">my.cnfの設定</h1>
<p>mysqlの設定ファイルは「my.cnf」というファイルです。 こちらでログの設定等を指定してあげるのですね。 主にチューニングを行うために編集することが多いです。</p>
<p>例1) ネットワーク関連のチューニングしたい</p>
<table>
<thead>
<tr class="header">
<th align="center">設定項目</th>
<th align="center">説明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">max_connections</td>
<td align="center">-</td>
</tr>
<tr class="even">
<td align="center">connect_timeout</td>
<td align="center">タイムアウト</td>
</tr>
<tr class="odd">
<td align="center">max_allowed_packet</td>
<td align="center">扱える最大容量</td>
</tr>
<tr class="even">
<td align="center">max_user_connections</td>
<td align="center">-</td>
</tr>
<tr class="odd">
<td align="center">wait_timeout</td>
<td align="center">-</td>
</tr>
<tr class="even">
<td align="center">interactive_timeout</td>
<td align="center">-</td>
</tr>
</tbody>
</table>
<p>例2) メモリ関連のチューニングしたい</p>
<table>
<thead>
<tr class="header">
<th align="center">設定項目</th>
<th align="center">説明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">thread_cache_size</td>
<td align="center">キャッシュ</td>
</tr>
<tr class="even">
<td align="center">table_open_cache</td>
<td align="center">キャッシュ</td>
</tr>
<tr class="odd">
<td align="center">query_cache_size</td>
<td align="center">キャッシュ</td>
</tr>
<tr class="even">
<td align="center">query_cache_limit</td>
<td align="center">キャッシュ</td>
</tr>
</tbody>
</table>
<p>などがあります。 このようなオプションの種別／利用方法／事例についてはMySQLの公式ページを参照 https://dev.mysql.com/doc/refman/5.6/ja/option-files.html</p>
<h2 id="ファイルパスと読み込み順序">ファイルパスと読み込み順序</h2>
<p>ですがこいつ、ややこしいことに複数います。 そして例によって読み込み順序を考慮し、設定しなければいけません。</p>
<table>
<thead>
<tr class="header">
<th align="center">読みこみ順序</th>
<th align="center">ファイルパス</th>
<th align="center">説明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">1</td>
<td align="center">/etc/my.cnf</td>
<td align="center">グローバルオプション</td>
</tr>
<tr class="even">
<td align="center">2</td>
<td align="center">/etc/mysql/my.cnf</td>
<td align="center">グローバルオプション</td>
</tr>
<tr class="odd">
<td align="center">3</td>
<td align="center">SYSCONFDIR/my.cnf</td>
<td align="center">グローバルオプション</td>
</tr>
<tr class="even">
<td align="center">4</td>
<td align="center">$MYSQL_HOME/my.cnf</td>
<td align="center">サーバー固有のオプション</td>
</tr>
<tr class="odd">
<td align="center">5</td>
<td align="center">defaults-extra-file</td>
<td align="center">--defaults-extra-file=path によって指定されるファイル</td>
</tr>
<tr class="even">
<td align="center">6</td>
<td align="center">~/.my.cnf</td>
<td align="center">ユーザー固有のオプション</td>
</tr>
<tr class="odd">
<td align="center">7</td>
<td align="center">~/.mylogin.cnf</td>
<td align="center">ログインパスオプション</td>
</tr>
</tbody>
</table>
<p>基本的に定義を分解する必要がない場合は/etc/my.cnfのみの設定でよいでしょう。</p>
<p>セキュリティ的面を考慮するならば、運用／保守ユーザー用、構築ユーザー用、 特権ユーザーなどの付与権限に応じて設定を分別するとよいでしょう。</p>
<p>読み込み順序についてはZabbixやnagios等の監視設定の継承と類似していますね。</p>
<h2 id="今回の設定内容">今回の設定内容</h2>
<p>今回は実行されたSQLを記録する、「一般クエリログ」の設定を追加してみましょう。</p>
<p>では実際に設定してみる。</p>
<p>(1).バックアップを取得する。</p>
<pre class="shell-session"><code>#フルコピー
cp -a /etc/my.cnf /etc/my.cnf.yyyymmdd-nn

#コピーできているか確認
ls -lh /etc/ | grep my.cnf
</code></pre>
<p>＊ここで、yyyymmddは作業年月日nnは連番</p>
<p>（2）.viエディタを起動</p>
<pre class="shell-session"><code>vi /etc/my.cnf</code></pre>
<p>「a」キーを押下し、インサートモードへ移行</p>
<p>（3）.設定の追加 以下を追加</p>
<pre class="shell-session"><code>general_log=1
general_log_file=/var/log/mysql/general-query.log</code></pre>
<p>「general_log」で一般クエリログを出力する／しないを設定します。 「1」なら有効、「0」なら無効です。</p>
<p>「general_log_file」で出力ファイルを指定してあげればOK。</p>
<p>(4).設定を保存 　 「esc」キーを押下し、「インサートモード」から「コマンドモード」へ移行しましょう。</p>
<p>画面下方の「INSERT」が消えればOK</p>
<p>次に「:wq」の順に押下して「ENTER」キーを押下してください。</p>
<p>これで編集完了です。</p>
<p>(5).設定内容の確認 設定が完了したら、ちゃんと設定できているのかを確認しましょう。 diffコマンドを用いて、</p>
<pre class="shell-session"><code>diff /etc/my.cnf /etc/my.cnf.yyyymmdd-nn</code></pre>
<p>(6).サービス再起動 ファイルを更新した後はもちろんサービス再起動ですね。 更新したファイルを再度読み込ませましょう。</p>
<pre class="shell-session"><code>#サービス再起動
systemctl restart mysqld

#確認
systemctl status mysqld</code></pre>
<p>activeだったらOKですね！ うぇ 後ほどログを確認してみましょう。</p>
<h1 id="mysqlへの接続">MySQLへの接続</h1>
<p>それではMySQLへ接続しましょう。</p>
<h2 id="謎のデフォルトパスワード">謎のデフォルトパスワード</h2>
<p>MySQLインストール時に特権ユーザーのパスワードがランダムで生成されます。 そのパスワードはログに記載されています。</p>
<p>実際に見てみよう！</p>
<pre class="shell-session"><code>[root@relay-server ec2-user]# cat /var/log/mysqld.log | grep pass
2018-05-23T16:09:05.032611Z 1 [Note] A temporary password is generated for root@localhost: eR/qaG&amp;_,4(D

2018-05-23T16:09:16.786969Z 2 [Note] Access denied for user &#39;root&#39;@&#39;localhost&#39; (using password: NO)

2018-05-23T16:09:29.951956Z 3 [Note] Access denied for user &#39;root&#39;@&#39;localhost&#39; (using password: YES)</code></pre>
<p>見つけることができましたか？ 上記の例でいえば「eR/qaG&amp;_,4(D」が特権ユーザーのパスワードですね。</p>
<p>こちらをメモっておいてください！</p>
<p>話は戻って、以下のコマンドを利用することによって一括で最低限のセキュリティ設定が可能です。</p>
<p>mysql_secure_installation</p>
<p>実際にこのコマンドで設定できる項目は以下</p>
<p>+root ユーザーのパスワードの変更 +VALIDATE PASSWORD プラグインのインストール +ポリシーに沿った root ユーザーパスワードの設定 (VALIDATE PASSWORD プラグインをインストールした場合) +anonymous ユーザーの削除 +リモートホストから root ユーザーでログインするのを禁止する +testデータベースの削除 (存在する場合)</p>
<p>では早速実行してみましょう。</p>
<p>すると最初に現在のパスワードを問われます。</p>
<pre class="shell-session"><code>Securing the MySQL server deployment.

Enter password for user root:</code></pre>
<p>先ほどメモった特権ユーザーのパスワードを入力しましょう。 すると、新しいパスワードを問われます。</p>
<p>今回は一律「P@$$w0rd」で再設定しましょう。</p>
<pre class="shell-session"><code>The existing password for the user account root has expired. Please set a new password.

New password: </code></pre>
<p>問題なければ次々行こう</p>
<pre class="shell-session"><code>[root@relay-server ec2-user]# mysql_secure_installation

Securing the MySQL server deployment.

Enter password for user root: 

The existing password for the user account root has expired. Please set a new password.

New password: 

Re-enter new password: 
The &#39;validate_password&#39; plugin is installed on the server.
The subsequent steps will run with the existing configuration
of the plugin.
Using existing password for root.

Estimated strength of the password: 100 
Change the password for root ? ((Press y|Y for Yes, any other key for No) : y

New password: 

Re-enter new password: 

Estimated strength of the password: 100 
Do you wish to continue with the password provided?(Press y|Y for Yes, any other key for No) : y
By default, a MySQL installation has an anonymous user,
allowing anyone to log into MySQL without having to have
a user account created for them. This is intended only for
testing, and to make the installation go a bit smoother.
You should remove them before moving into a production
environment.

Remove anonymous users? (Press y|Y for Yes, any other key for No) : y
Success.


Normally, root should only be allowed to connect from
&#39;localhost&#39;. This ensures that someone cannot guess at
the root password from the network.

Disallow root login remotely? (Press y|Y for Yes, any other key for No) : y
Success.

By default, MySQL comes with a database named &#39;test&#39; that
anyone can access. This is also intended only for testing,
and should be removed before moving into a production
environment.


Remove test database and access to it? (Press y|Y for Yes, any other key for No) : y
 - Dropping test database...
Success.

 - Removing privileges on test database...
Success.

Reloading the privilege tables will ensure that all changes
made so far will take effect immediately.

Reload privilege tables now? (Press y|Y for Yes, any other key for No) : y
Success.

All done! 
[root@relay-server ec2-user]
</code></pre>
<p>OKじゃね。</p>
<p>と、いうことで接続しましょう。</p>
<p>以下のコマンドを実行しましょう。</p>
<pre class="shell-session"><code>[root@relay-server ec2-user]# mysql -u root -p
Enter password: 
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 7
Server version: 5.7.22 MySQL Community Server (GPL)

Copyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type &#39;help;&#39; or &#39;\h&#39; for help. Type &#39;\c&#39; to clear the current input statement.

mysql&gt; 
</code></pre>
<p>でけましたか？ できた場合は次のステップに進みましょう。</p>
<h2 id="データベースの作成">データベースの作成</h2>
<p>ログインまでできたところで、データベースを作成してみましょう。</p>
<p>以下のようなデータベースを作成したいと思います。</p>
<p>データベースの構成</p>
<p>|:-----------:|:-----------:| | データベース名 | Organization | | テーブル名 | user |</p>
<p>テーブル内容</p>
<table>
<thead>
<tr class="header">
<th align="center">id</th>
<th align="center">name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">0001</td>
<td align="center">user01</td>
</tr>
<tr class="even">
<td align="center">0002</td>
<td align="center">user02</td>
</tr>
</tbody>
</table>
<p>ではまずは「がわ」となる、データベースを作成しましょう。</p>
<p>以下のコマンドを実行してみてください。</p>
<pre class="shell-session"><code>create database Organization;</code></pre>
<p>「Query OK,」と出力されればOKです。</p>
<p>実際に作成されたのか確認しましょう。 「show」コマンドでデータベースを確認しましょう。</p>
<pre class="shell-session"><code>show databases;</code></pre>
<p>見れましたか？</p>
<h2 id="テーブルの作成">テーブルの作成</h2>
<p>次にテーブルを作成しましょう。 「表」のことをテーブルというんでしたね！</p>
<p>「use」コマンドを使ってデータベースに接続できます！ 実際にやってみよう！</p>
<pre class="shell-session"><code>use Organization;</code></pre>
<p>エラーなく接続できたかな？ ではテーブルを作成してみよう！</p>
<p>以下のコマンドを実行してください。</p>
<pre class="shell-session"><code>create table user;</code></pre>
<p>「Query OK,」と出力されればOKです。 ここまでで、データを入れるテーブル（表）、テーブルを入れるデータベースが作成できました！</p>
<h2 id="データをインサートする">データをインサートする</h2>
<p>器の準備ができたらデータを入れましょう。</p>
<p>以下のコマンドを実行してください。</p>
<pre class="shell-session"><code>insert iinto user(id,name) values(0001,user01);</code></pre>
<h2 id="データをセレクトする">データをセレクトする</h2>
<p>データを入れてみたら、次はデータを取り出してみましょう！ 以下のコマンドを実行してみてください。</p>
<pre class="shell-session"><code>select * from user;</code></pre>
<p>データが表示されたら成功です！</p>
<p>流れがわかったところで、自力で「id：0002、name：user02」をインサート／確認してみよう！</p>
 
 
<p><a href="MySQL-01.html">BACK</a></p>
</body>
